{"ast":null,"code":"import _objectSpread from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/helpers/esm/createSuper\";import{Streamlit,StreamlitComponentBase,withStreamlitConnection}from\"streamlit-component-lib\";import React from\"react\";var StreamlitAudioRecorder=/*#__PURE__*/function(_StreamlitComponentBa){_inherits(StreamlitAudioRecorder,_StreamlitComponentBa);var _super=_createSuper(StreamlitAudioRecorder);function StreamlitAudioRecorder(props){var _this;_classCallCheck(this,StreamlitAudioRecorder);_this=_super.call(this,props);_this.chunks=[];_this.audioContext=null;_this.analyser=null;_this.animationId=null;_this.canvasRef=void 0;_this.drawWaveform=function(){var canvas=_this.canvasRef.current;if(!canvas||!_this.analyser)return;var canvasCtx=canvas.getContext('2d');if(!canvasCtx)return;var bufferLength=_this.analyser.frequencyBinCount;var dataArray=new Uint8Array(bufferLength);var draw=function draw(){_this.animationId=requestAnimationFrame(draw);_this.analyser.getByteTimeDomainData(dataArray);canvasCtx.fillStyle='rgb(200, 200, 200)';canvasCtx.fillRect(0,0,canvas.width,canvas.height);canvasCtx.lineWidth=2;canvasCtx.strokeStyle='rgb(0, 0, 0)';canvasCtx.beginPath();var sliceWidth=canvas.width*1.0/bufferLength;var x=0;for(var i=0;i<bufferLength;i++){var v=dataArray[i]/128.0;var y=v*canvas.height/2;if(i===0){canvasCtx.moveTo(x,y);}else{canvasCtx.lineTo(x,y);}x+=sliceWidth;}canvasCtx.lineTo(canvas.width,canvas.height/2);canvasCtx.stroke();};draw();};_this.startRecording=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var stream,source,mediaRecorder;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return navigator.mediaDevices.getUserMedia({audio:{channelCount:1,sampleRate:44100,echoCancellation:true,noiseSuppression:true,autoGainControl:true}});case 3:stream=_context.sent;// Set up audio context and analyser for visualization\n_this.audioContext=new AudioContext();source=_this.audioContext.createMediaStreamSource(stream);_this.analyser=_this.audioContext.createAnalyser();_this.analyser.fftSize=2048;source.connect(_this.analyser);mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/webm',audioBitsPerSecond:128000});_this.chunks=[];mediaRecorder.ondataavailable=function(e){if(e.data.size>0){_this.chunks.push(e.data);}};mediaRecorder.onstop=function(){// First, update UI state to show we've stopped recording\n_this.setState({isRecording:false,mediaRecorder:null});// Create blob and handle audio playback\nvar blob=new Blob(_this.chunks,{type:'audio/webm'});if(_this.state.audioUrl){URL.revokeObjectURL(_this.state.audioUrl);}var audioUrl=URL.createObjectURL(blob);_this.setState({audioBlob:blob,audioUrl:audioUrl});// Send data to Streamlit in the background\nblob.arrayBuffer().then(function(buffer){var uint8Array=new Uint8Array(buffer);Streamlit.setComponentValue(uint8Array);});// Clean up visualization\nif(_this.animationId){cancelAnimationFrame(_this.animationId);}};mediaRecorder.start(100);_this.setState({mediaRecorder:mediaRecorder,isRecording:true});_this.drawWaveform();_context.next=22;break;case 18:_context.prev=18;_context.t0=_context[\"catch\"](0);console.error(\"Error accessing microphone:\",_context.t0);Streamlit.setComponentValue(null);case 22:case\"end\":return _context.stop();}}},_callee,null,[[0,18]]);}));_this.stopRecording=function(){if(_this.state.mediaRecorder&&_this.state.isRecording){_this.state.mediaRecorder.stop();_this.state.mediaRecorder.stream.getTracks().forEach(function(track){return track.stop();});if(_this.audioContext){_this.audioContext.close();}}};_this.resetRecording=function(){if(_this.state.mediaRecorder){_this.state.mediaRecorder.stream.getTracks().forEach(function(track){return track.stop();});}if(_this.audioContext){_this.audioContext.close();}if(_this.animationId){cancelAnimationFrame(_this.animationId);}if(_this.state.audioUrl){URL.revokeObjectURL(_this.state.audioUrl);}_this.chunks=[];_this.setState({isRecording:false,audioBlob:null,audioUrl:null,mediaRecorder:null,audioData:[]});Streamlit.setComponentValue(null);};_this.render=function(){var theme=_this.props.theme;var style={};if(theme){var borderStyling=\"1px solid \".concat(_this.state.isRecording?theme.primaryColor:\"gray\");style.border=borderStyling;style.outline=borderStyling;}return/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"div\",{style:{marginBottom:'1rem'}},/*#__PURE__*/React.createElement(\"button\",{id:\"record\",onClick:_this.state.isRecording?_this.stopRecording:_this.startRecording,style:_objectSpread(_objectSpread({},style),{},{marginRight:'0.5rem',padding:'0.5rem 1rem',cursor:'pointer'})},_this.state.isRecording?'Stop Recording':'Start Recording'),/*#__PURE__*/React.createElement(\"button\",{id:\"reset\",onClick:_this.resetRecording,style:_objectSpread(_objectSpread({},style),{},{padding:'0.5rem 1rem',cursor:_this.state.isRecording?'not-allowed':'pointer'}),disabled:_this.state.isRecording},\"Reset\")),/*#__PURE__*/React.createElement(\"canvas\",{ref:_this.canvasRef,width:\"300\",height:\"100\",style:{display:_this.state.isRecording?'block':'none',border:'1px solid #ccc',marginBottom:'1rem',borderRadius:'4px'}}),_this.state.audioUrl&&/*#__PURE__*/React.createElement(\"div\",{style:{marginTop:'1rem'}},/*#__PURE__*/React.createElement(\"audio\",{id:\"audio\",controls:true,src:_this.state.audioUrl,style:{width:'100%',height:'50px',borderRadius:'4px'},preload:\"metadata\"})));};_this.state={isRecording:false,mediaRecorder:null,audioBlob:null,audioUrl:null,audioData:[]};_this.canvasRef=React.createRef();return _this;}_createClass(StreamlitAudioRecorder,[{key:\"componentWillUnmount\",value:function componentWillUnmount(){if(this.animationId){cancelAnimationFrame(this.animationId);}if(this.audioContext){this.audioContext.close();}if(this.state.audioUrl){URL.revokeObjectURL(this.state.audioUrl);}}}]);return StreamlitAudioRecorder;}(StreamlitComponentBase);export default withStreamlitConnection(StreamlitAudioRecorder);Streamlit.setComponentReady();Streamlit.setFrameHeight();","map":{"version":3,"sources":["/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/src/StreamlitAudioRecorder.tsx"],"names":["Streamlit","StreamlitComponentBase","withStreamlitConnection","React","StreamlitAudioRecorder","props","chunks","audioContext","analyser","animationId","canvasRef","drawWaveform","canvas","current","canvasCtx","getContext","bufferLength","frequencyBinCount","dataArray","Uint8Array","draw","requestAnimationFrame","getByteTimeDomainData","fillStyle","fillRect","width","height","lineWidth","strokeStyle","beginPath","sliceWidth","x","i","v","y","moveTo","lineTo","stroke","startRecording","navigator","mediaDevices","getUserMedia","audio","channelCount","sampleRate","echoCancellation","noiseSuppression","autoGainControl","stream","AudioContext","source","createMediaStreamSource","createAnalyser","fftSize","connect","mediaRecorder","MediaRecorder","mimeType","audioBitsPerSecond","ondataavailable","e","data","size","push","onstop","setState","isRecording","blob","Blob","type","state","audioUrl","URL","revokeObjectURL","createObjectURL","audioBlob","arrayBuffer","then","buffer","uint8Array","setComponentValue","cancelAnimationFrame","start","console","error","stopRecording","stop","getTracks","forEach","track","close","resetRecording","audioData","render","theme","style","borderStyling","primaryColor","border","outline","marginBottom","marginRight","padding","cursor","display","borderRadius","marginTop","createRef","setComponentReady","setFrameHeight"],"mappings":"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","sourcesContent":["import {\n  Streamlit,\n  StreamlitComponentBase,\n  withStreamlitConnection,\n} from \"streamlit-component-lib\"\nimport React, { ReactNode } from \"react\"\n\ninterface State {\n  isRecording: boolean\n  mediaRecorder: MediaRecorder | null\n  audioBlob: Blob | null\n  audioUrl: string | null\n  audioData: number[]\n}\n\nclass StreamlitAudioRecorder extends StreamlitComponentBase {\n  private chunks: Blob[] = [];\n  private audioContext: AudioContext | null = null;\n  private analyser: AnalyserNode | null = null;\n  private animationId: number | null = null;\n  private canvasRef: React.RefObject<HTMLCanvasElement | null>;\n\n  constructor(props: any) {\n    super(props)\n    this.state = {\n      isRecording: false,\n      mediaRecorder: null,\n      audioBlob: null,\n      audioUrl: null,\n      audioData: []\n    }\n    this.canvasRef = React.createRef<HTMLCanvasElement>();\n  }\n\n  componentWillUnmount() {\n    if (this.animationId) {\n      cancelAnimationFrame(this.animationId);\n    }\n    if (this.audioContext) {\n      this.audioContext.close();\n    }\n    if (this.state.audioUrl) {\n      URL.revokeObjectURL(this.state.audioUrl);\n    }\n  }\n\n  drawWaveform = () => {\n    const canvas = this.canvasRef.current;\n    if (!canvas || !this.analyser) return;\n\n    const canvasCtx = canvas.getContext('2d');\n    if (!canvasCtx) return;\n\n    const bufferLength = this.analyser.frequencyBinCount;\n    const dataArray = new Uint8Array(bufferLength);\n\n    const draw = () => {\n      this.animationId = requestAnimationFrame(draw);\n      this.analyser!.getByteTimeDomainData(dataArray);\n\n      canvasCtx.fillStyle = 'rgb(200, 200, 200)';\n      canvasCtx.fillRect(0, 0, canvas.width, canvas.height);\n      canvasCtx.lineWidth = 2;\n      canvasCtx.strokeStyle = 'rgb(0, 0, 0)';\n      canvasCtx.beginPath();\n\n      const sliceWidth = canvas.width * 1.0 / bufferLength;\n      let x = 0;\n\n      for (let i = 0; i < bufferLength; i++) {\n        const v = dataArray[i] / 128.0;\n        const y = v * canvas.height / 2;\n\n        if (i === 0) {\n          canvasCtx.moveTo(x, y);\n        } else {\n          canvasCtx.lineTo(x, y);\n        }\n\n        x += sliceWidth;\n      }\n\n      canvasCtx.lineTo(canvas.width, canvas.height / 2);\n      canvasCtx.stroke();\n    };\n\n    draw();\n  };\n\n  startRecording = async () => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({\n        audio: {\n          channelCount: 1,\n          sampleRate: 44100,\n          echoCancellation: true,\n          noiseSuppression: true,\n          autoGainControl: true\n        }\n      });\n\n      // Set up audio context and analyser for visualization\n      this.audioContext = new AudioContext();\n      const source = this.audioContext.createMediaStreamSource(stream);\n      this.analyser = this.audioContext.createAnalyser();\n      this.analyser.fftSize = 2048;\n      source.connect(this.analyser);\n\n      const mediaRecorder = new MediaRecorder(stream, {\n        mimeType: 'audio/webm',\n        audioBitsPerSecond: 128000\n      });\n\n      this.chunks = [];\n\n      mediaRecorder.ondataavailable = (e: BlobEvent) => {\n        if (e.data.size > 0) {\n          this.chunks.push(e.data);\n        }\n      };\n\n      mediaRecorder.onstop = () => {\n        // First, update UI state to show we've stopped recording\n        this.setState({ isRecording: false, mediaRecorder: null });\n\n        // Create blob and handle audio playback\n        const blob = new Blob(this.chunks, { type: 'audio/webm' });\n        if (this.state.audioUrl) {\n          URL.revokeObjectURL(this.state.audioUrl);\n        }\n        const audioUrl = URL.createObjectURL(blob);\n        this.setState({ audioBlob: blob, audioUrl });\n\n        // Send data to Streamlit in the background\n        blob.arrayBuffer().then(buffer => {\n          const uint8Array = new Uint8Array(buffer);\n          Streamlit.setComponentValue(uint8Array);\n        });\n\n        // Clean up visualization\n        if (this.animationId) {\n          cancelAnimationFrame(this.animationId);\n        }\n      };\n\n      mediaRecorder.start(100);\n      this.setState({ mediaRecorder, isRecording: true });\n      this.drawWaveform();\n\n    } catch (err) {\n      console.error(\"Error accessing microphone:\", err);\n      Streamlit.setComponentValue(null);\n    }\n  };\n\n  stopRecording = () => {\n    if (this.state.mediaRecorder && this.state.isRecording) {\n      this.state.mediaRecorder.stop();\n      this.state.mediaRecorder.stream.getTracks().forEach((track: MediaStreamTrack) => track.stop());\n      if (this.audioContext) {\n        this.audioContext.close();\n      }\n    }\n  };\n\n  resetRecording = (): void => {\n    if (this.state.mediaRecorder) {\n      this.state.mediaRecorder.stream.getTracks().forEach((track: MediaStreamTrack) => track.stop());\n    }\n    if (this.audioContext) {\n      this.audioContext.close();\n    }\n    if (this.animationId) {\n      cancelAnimationFrame(this.animationId);\n    }\n    if (this.state.audioUrl) {\n      URL.revokeObjectURL(this.state.audioUrl);\n    }\n    this.chunks = [];\n    this.setState({\n      isRecording: false,\n      audioBlob: null,\n      audioUrl: null,\n      mediaRecorder: null,\n      audioData: []\n    });\n    Streamlit.setComponentValue(null);\n  };\n\n  public render = (): ReactNode => {\n    const theme = this.props.theme;\n    const style: React.CSSProperties = {};\n\n    if (theme) {\n      const borderStyling = `1px solid ${\n        this.state.isRecording ? theme.primaryColor : \"gray\"\n      }`;\n      style.border = borderStyling;\n      style.outline = borderStyling;\n    }\n\n    return (\n      <div>\n        <div style={{ marginBottom: '1rem' }}>\n          <button \n            id=\"record\" \n            onClick={this.state.isRecording ? this.stopRecording : this.startRecording}\n            style={{\n              ...style,\n              marginRight: '0.5rem',\n              padding: '0.5rem 1rem',\n              cursor: 'pointer'\n            }}\n          >\n            {this.state.isRecording ? 'Stop Recording' : 'Start Recording'}\n          </button>\n          <button \n            id=\"reset\" \n            onClick={this.resetRecording} \n            style={{\n              ...style,\n              padding: '0.5rem 1rem',\n              cursor: this.state.isRecording ? 'not-allowed' : 'pointer'\n            }}\n            disabled={this.state.isRecording}\n          >\n            Reset\n          </button>\n        </div>\n        \n        <canvas \n          ref={this.canvasRef} \n          width=\"300\" \n          height=\"100\" \n          style={{ \n            display: this.state.isRecording ? 'block' : 'none',\n            border: '1px solid #ccc',\n            marginBottom: '1rem',\n            borderRadius: '4px'\n          }}\n        />\n        \n        {this.state.audioUrl && (\n          <div style={{ marginTop: '1rem' }}>\n            <audio\n              id=\"audio\"\n              controls\n              src={this.state.audioUrl}\n              style={{ \n                width: '100%',\n                height: '50px',\n                borderRadius: '4px'\n              }}\n              preload=\"metadata\"\n            />\n          </div>\n        )}\n      </div>\n    );\n  }\n}\n\nexport default withStreamlitConnection(StreamlitAudioRecorder);\n\nStreamlit.setComponentReady();\nStreamlit.setFrameHeight();\n"]},"metadata":{},"sourceType":"module"}