{"ast":null,"code":"import _regeneratorRuntime from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/regenerator\";import _toConsumableArray from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _asyncToGenerator from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/node_modules/@babel/runtime/helpers/esm/createSuper\";import{Streamlit,StreamlitComponentBase,withStreamlitConnection}from\"streamlit-component-lib\";import React from\"react\";var StreamlitAudioRecorder=/*#__PURE__*/function(_StreamlitComponentBa){_inherits(StreamlitAudioRecorder,_StreamlitComponentBa);var _super=_createSuper(StreamlitAudioRecorder);function StreamlitAudioRecorder(props){var _this;_classCallCheck(this,StreamlitAudioRecorder);_this=_super.call(this,props);_this.canvasRef=void 0;_this.sessionId=void 0;_this.drawWaveform=function(){if(_this.state.analyser&&_this.canvasRef.current){var canvas=_this.canvasRef.current;var canvasCtx=canvas.getContext('2d');var bufferLength=_this.state.analyser.frequencyBinCount;var dataArray=new Uint8Array(bufferLength);var draw=function draw(){if(!_this.state.isRecording){if(_this.state.animationId){cancelAnimationFrame(_this.state.animationId);}return;}var animationId=requestAnimationFrame(draw);_this.setState({animationId:animationId});_this.state.analyser.getByteTimeDomainData(dataArray);if(canvasCtx){// Modern background\ncanvasCtx.fillStyle='#f0f0f0';canvasCtx.fillRect(0,0,canvas.width,canvas.height);// Create gradient for the waveform\nvar gradient=canvasCtx.createLinearGradient(0,0,canvas.width,0);gradient.addColorStop(0,'#ff4b4b');gradient.addColorStop(1,'#ff8b8b');canvasCtx.lineWidth=3;canvasCtx.strokeStyle=gradient;canvasCtx.beginPath();var sliceWidth=canvas.width*1.0/bufferLength;var x=0;var lastY=canvas.height/2;for(var i=0;i<bufferLength;i++){var v=dataArray[i]/128.0;var y=v*canvas.height/2;// Smooth the line using bezier curves\nif(i===0){canvasCtx.moveTo(x,y);}else{var xc=(x+(x-sliceWidth))/2;canvasCtx.quadraticCurveTo(x-sliceWidth,lastY,xc,y);}lastY=y;x+=sliceWidth;}canvasCtx.lineTo(canvas.width,canvas.height/2);canvasCtx.stroke();}};draw();}};_this.startRecording=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var stream,audioContext,source,analyser,mediaRecorder,CHUNK_INTERVAL,currentChunks,chunkCounter,sendChunksInterval;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;_context3.next=3;return navigator.mediaDevices.getUserMedia({audio:{channelCount:1,sampleRate:44100,echoCancellation:true,noiseSuppression:true,autoGainControl:true}});case 3:stream=_context3.sent;audioContext=new AudioContext();source=audioContext.createMediaStreamSource(stream);analyser=audioContext.createAnalyser();source.connect(analyser);mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/webm;codecs=opus',audioBitsPerSecond:128000});// Send chunks every 5 seconds to stay well under Streamlit's size limits\nCHUNK_INTERVAL=5000;// 5 seconds\ncurrentChunks=[];chunkCounter=0;mediaRecorder.ondataavailable=function(e){if(e.data.size>0){currentChunks.push(e.data);_this.setState(function(prev){return{previewChunks:[].concat(_toConsumableArray(prev.previewChunks),[e.data])};});}};// Periodically send chunks\nsendChunksInterval=setInterval(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var blob,buffer,uint8Array;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(currentChunks.length>0&&_this.state.isRecording)){_context.next=8;break;}blob=new Blob(currentChunks,{type:'audio/webm;codecs=opus'});currentChunks=[];// Clear current chunks after creating blob\n_context.next=5;return blob.arrayBuffer();case 5:buffer=_context.sent;uint8Array=new Uint8Array(buffer);Streamlit.setComponentValue({arr:Object.fromEntries(uint8Array.entries()),chunkId:chunkCounter++,sessionId:_this.sessionId,isFinal:false});case 8:case\"end\":return _context.stop();}}},_callee);})),CHUNK_INTERVAL);mediaRecorder.onstop=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var blob,buffer,uint8Array,previewBlob;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:clearInterval(sendChunksInterval);// Send any remaining chunks\nif(!(currentChunks.length>0)){_context2.next=8;break;}blob=new Blob(currentChunks,{type:'audio/webm;codecs=opus'});_context2.next=5;return blob.arrayBuffer();case 5:buffer=_context2.sent;uint8Array=new Uint8Array(buffer);Streamlit.setComponentValue({arr:Object.fromEntries(uint8Array.entries()),chunkId:chunkCounter,sessionId:_this.sessionId,isFinal:true});case 8:// Create preview blob from all chunks\npreviewBlob=new Blob(_this.state.previewChunks,{type:'audio/webm;codecs=opus'});_this.setState({chunks:[],previewChunks:[],isRecording:false,mediaRecorder:null,audioBlob:previewBlob,audioUrl:URL.createObjectURL(previewBlob)});case 10:case\"end\":return _context2.stop();}}},_callee2);}));// Start recording in smaller intervals for smooth waveform\nmediaRecorder.start(100);_this.setState({mediaRecorder:mediaRecorder,isRecording:true,analyser:analyser,previewChunks:[],// Clear preview chunks when starting new recording\naudioUrl:null,// Clear previous audio URL\naudioBlob:null// Clear previous blob\n},_this.drawWaveform);_context3.next=22;break;case 19:_context3.prev=19;_context3.t0=_context3[\"catch\"](0);console.error(\"Error accessing microphone:\",_context3.t0);case 22:case\"end\":return _context3.stop();}}},_callee3,null,[[0,19]]);}));_this.stopRecording=function(){if(_this.state.mediaRecorder&&_this.state.isRecording){_this.state.mediaRecorder.stop();_this.state.mediaRecorder.stream.getTracks().forEach(function(track){return track.stop();});if(_this.state.animationId){cancelAnimationFrame(_this.state.animationId);}}};_this.resetRecording=function(){if(_this.state.animationId){cancelAnimationFrame(_this.state.animationId);}if(_this.state.audioUrl){URL.revokeObjectURL(_this.state.audioUrl);}_this.setState({isRecording:false,audioBlob:null,chunks:[],previewChunks:[],audioUrl:null,audioData:null,analyser:null,animationId:null});Streamlit.setComponentValue(null);};_this.downloadRecording=function(){if(_this.state.audioBlob){var datetime=new Date().toLocaleString().replace(/[\\s,]/g,'').replace(/_/g,'');var filename=\"streamlit_audio_\".concat(datetime,\".webm\");var a=document.createElement('a');a.style.display='none';a.href=URL.createObjectURL(_this.state.audioBlob);a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);}};_this.render=function(){var theme=_this.props.theme;var style={};if(theme){var borderStyling=\"1px solid \".concat(_this.state.isRecording?'#ff4b4b':\"#e0e0e0\");style.border=borderStyling;style.outline=borderStyling;}return/*#__PURE__*/React.createElement(\"div\",{style:{padding:'20px',background:'white',borderRadius:'10px',boxShadow:'0 2px 10px rgba(0,0,0,0.1)'}},/*#__PURE__*/React.createElement(\"canvas\",{ref:_this.canvasRef,width:\"500\",height:\"100\",style:{width:'100%',marginBottom:'20px',borderRadius:'5px',backgroundColor:_this.state.isRecording?'#fff4f4':'#f0f0f0'}}),/*#__PURE__*/React.createElement(\"div\",{style:{display:'flex',gap:'10px',justifyContent:'center'}},!_this.state.isRecording?/*#__PURE__*/React.createElement(\"button\",{onClick:_this.startRecording,style:{padding:'10px 20px',borderRadius:'5px',border:'none',backgroundColor:'#ff4b4b',color:'white',cursor:'pointer'}},\"Start Recording\"):/*#__PURE__*/React.createElement(\"button\",{onClick:_this.stopRecording,style:{padding:'10px 20px',borderRadius:'5px',border:'none',backgroundColor:'#4b4bff',color:'white',cursor:'pointer'}},\"Stop Recording\"),_this.state.audioUrl&&/*#__PURE__*/React.createElement(\"audio\",{src:_this.state.audioUrl,controls:true,style:{marginTop:'10px',width:'100%'}})));};_this.state={isRecording:false,mediaRecorder:null,audioBlob:null,chunks:[],audioUrl:null,audioData:null,analyser:null,animationId:null,previewChunks:[]};_this.canvasRef=React.createRef();_this.sessionId='rec_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);return _this;}_createClass(StreamlitAudioRecorder,[{key:\"componentDidMount\",value:function componentDidMount(){// Initialize canvas with a modern look\nif(this.canvasRef.current){var canvas=this.canvasRef.current;var canvasCtx=canvas.getContext('2d');if(canvasCtx){canvasCtx.fillStyle='#f0f0f0';canvasCtx.fillRect(0,0,canvas.width,canvas.height);// Create gradient for the line\nvar gradient=canvasCtx.createLinearGradient(0,0,canvas.width,0);gradient.addColorStop(0,'#ff4b4b');gradient.addColorStop(1,'#ff8b8b');canvasCtx.strokeStyle=gradient;canvasCtx.lineWidth=3;canvasCtx.beginPath();canvasCtx.moveTo(0,canvas.height/2);canvasCtx.lineTo(canvas.width,canvas.height/2);canvasCtx.stroke();}}}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){if(this.state.animationId){cancelAnimationFrame(this.state.animationId);}}}]);return StreamlitAudioRecorder;}(StreamlitComponentBase);export default withStreamlitConnection(StreamlitAudioRecorder);Streamlit.setComponentReady();Streamlit.setFrameHeight();","map":{"version":3,"sources":["/home/jani/readout_bot/libs/streamlit-audio-recorder/st_audiorec/frontend/src/StreamlitAudioRecorder.tsx"],"names":["Streamlit","StreamlitComponentBase","withStreamlitConnection","React","StreamlitAudioRecorder","props","canvasRef","sessionId","drawWaveform","state","analyser","current","canvas","canvasCtx","getContext","bufferLength","frequencyBinCount","dataArray","Uint8Array","draw","isRecording","animationId","cancelAnimationFrame","requestAnimationFrame","setState","getByteTimeDomainData","fillStyle","fillRect","width","height","gradient","createLinearGradient","addColorStop","lineWidth","strokeStyle","beginPath","sliceWidth","x","lastY","i","v","y","moveTo","xc","quadraticCurveTo","lineTo","stroke","startRecording","navigator","mediaDevices","getUserMedia","audio","channelCount","sampleRate","echoCancellation","noiseSuppression","autoGainControl","stream","audioContext","AudioContext","source","createMediaStreamSource","createAnalyser","connect","mediaRecorder","MediaRecorder","mimeType","audioBitsPerSecond","CHUNK_INTERVAL","currentChunks","chunkCounter","ondataavailable","e","data","size","push","prev","previewChunks","sendChunksInterval","setInterval","length","blob","Blob","type","arrayBuffer","buffer","uint8Array","setComponentValue","arr","Object","fromEntries","entries","chunkId","isFinal","onstop","clearInterval","previewBlob","chunks","audioBlob","audioUrl","URL","createObjectURL","start","console","error","stopRecording","stop","getTracks","forEach","track","resetRecording","revokeObjectURL","audioData","downloadRecording","datetime","Date","toLocaleString","replace","filename","a","document","createElement","style","display","href","download","body","appendChild","click","removeChild","render","theme","borderStyling","border","outline","padding","background","borderRadius","boxShadow","marginBottom","backgroundColor","gap","justifyContent","color","cursor","marginTop","createRef","now","Math","random","toString","substr","setComponentReady","setFrameHeight"],"mappings":"yjCAAA,OACEA,SADF,CAEEC,sBAFF,CAGEC,uBAHF,KAIO,yBAJP,CAKA,MAAOC,CAAAA,KAAP,KAAiC,OAAjC,C,GAcMC,CAAAA,sB,sJAIJ,gCAAYC,KAAZ,CAAwB,wDACtB,uBAAMA,KAAN,EADsB,MAHhBC,SAGgB,cAFhBC,SAEgB,cA+CxBC,YA/CwB,CA+CT,UAAM,CACnB,GAAI,MAAKC,KAAL,CAAWC,QAAX,EAAuB,MAAKJ,SAAL,CAAeK,OAA1C,CAAmD,CACjD,GAAMC,CAAAA,MAAM,CAAG,MAAKN,SAAL,CAAeK,OAA9B,CACA,GAAME,CAAAA,SAAS,CAAGD,MAAM,CAACE,UAAP,CAAkB,IAAlB,CAAlB,CACA,GAAMC,CAAAA,YAAY,CAAG,MAAKN,KAAL,CAAWC,QAAX,CAAoBM,iBAAzC,CACA,GAAMC,CAAAA,SAAS,CAAG,GAAIC,CAAAA,UAAJ,CAAeH,YAAf,CAAlB,CAEA,GAAMI,CAAAA,IAAI,CAAG,QAAPA,CAAAA,IAAO,EAAM,CACjB,GAAI,CAAC,MAAKV,KAAL,CAAWW,WAAhB,CAA6B,CAC3B,GAAI,MAAKX,KAAL,CAAWY,WAAf,CAA4B,CAC1BC,oBAAoB,CAAC,MAAKb,KAAL,CAAWY,WAAZ,CAApB,CACD,CACD,OACD,CAED,GAAMA,CAAAA,WAAW,CAAGE,qBAAqB,CAACJ,IAAD,CAAzC,CACA,MAAKK,QAAL,CAAc,CAAEH,WAAW,CAAXA,WAAF,CAAd,EAEA,MAAKZ,KAAL,CAAWC,QAAX,CAAqBe,qBAArB,CAA2CR,SAA3C,EAEA,GAAIJ,SAAJ,CAAe,CACb;AACAA,SAAS,CAACa,SAAV,CAAsB,SAAtB,CACAb,SAAS,CAACc,QAAV,CAAmB,CAAnB,CAAsB,CAAtB,CAAyBf,MAAM,CAACgB,KAAhC,CAAuChB,MAAM,CAACiB,MAA9C,EAEA;AACA,GAAMC,CAAAA,QAAQ,CAAGjB,SAAS,CAACkB,oBAAV,CAA+B,CAA/B,CAAkC,CAAlC,CAAqCnB,MAAM,CAACgB,KAA5C,CAAmD,CAAnD,CAAjB,CACAE,QAAQ,CAACE,YAAT,CAAsB,CAAtB,CAAyB,SAAzB,EACAF,QAAQ,CAACE,YAAT,CAAsB,CAAtB,CAAyB,SAAzB,EAEAnB,SAAS,CAACoB,SAAV,CAAsB,CAAtB,CACApB,SAAS,CAACqB,WAAV,CAAwBJ,QAAxB,CACAjB,SAAS,CAACsB,SAAV,GAEA,GAAMC,CAAAA,UAAU,CAAIxB,MAAM,CAACgB,KAAP,CAAe,GAAhB,CAAuBb,YAA1C,CACA,GAAIsB,CAAAA,CAAC,CAAG,CAAR,CACA,GAAIC,CAAAA,KAAK,CAAG1B,MAAM,CAACiB,MAAP,CAAgB,CAA5B,CAEA,IAAK,GAAIU,CAAAA,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGxB,YAApB,CAAkCwB,CAAC,EAAnC,CAAuC,CACrC,GAAMC,CAAAA,CAAC,CAAGvB,SAAS,CAACsB,CAAD,CAAT,CAAe,KAAzB,CACA,GAAME,CAAAA,CAAC,CAAID,CAAC,CAAG5B,MAAM,CAACiB,MAAZ,CAAsB,CAAhC,CAEA;AACA,GAAIU,CAAC,GAAK,CAAV,CAAa,CACX1B,SAAS,CAAC6B,MAAV,CAAiBL,CAAjB,CAAoBI,CAApB,EACD,CAFD,IAEO,CACL,GAAME,CAAAA,EAAE,CAAG,CAACN,CAAC,EAAIA,CAAC,CAAGD,UAAR,CAAF,EAAyB,CAApC,CACAvB,SAAS,CAAC+B,gBAAV,CAA2BP,CAAC,CAAGD,UAA/B,CAA2CE,KAA3C,CAAkDK,EAAlD,CAAsDF,CAAtD,EACD,CAEDH,KAAK,CAAGG,CAAR,CACAJ,CAAC,EAAID,UAAL,CACD,CAEDvB,SAAS,CAACgC,MAAV,CAAiBjC,MAAM,CAACgB,KAAxB,CAA+BhB,MAAM,CAACiB,MAAP,CAAgB,CAA/C,EACAhB,SAAS,CAACiC,MAAV,GACD,CACF,CAlDD,CAoDA3B,IAAI,GACL,CACF,CA5GuB,OA8GxB4B,cA9GwB,sEA8GP,mSAEQC,CAAAA,SAAS,CAACC,YAAV,CAAuBC,YAAvB,CAAoC,CACvDC,KAAK,CAAE,CACLC,YAAY,CAAE,CADT,CAELC,UAAU,CAAE,KAFP,CAGLC,gBAAgB,CAAE,IAHb,CAILC,gBAAgB,CAAE,IAJb,CAKLC,eAAe,CAAE,IALZ,CADgD,CAApC,CAFR,QAEPC,MAFO,gBAYPC,YAZO,CAYQ,GAAIC,CAAAA,YAAJ,EAZR,CAaPC,MAbO,CAaEF,YAAY,CAACG,uBAAb,CAAqCJ,MAArC,CAbF,CAcP/C,QAdO,CAcIgD,YAAY,CAACI,cAAb,EAdJ,CAebF,MAAM,CAACG,OAAP,CAAerD,QAAf,EAEMsD,aAjBO,CAiBS,GAAIC,CAAAA,aAAJ,CAAkBR,MAAlB,CAA0B,CAC9CS,QAAQ,CAAE,wBADoC,CAE9CC,kBAAkB,CAAE,MAF0B,CAA1B,CAjBT,CAsBb;AACMC,cAvBO,CAuBU,IAvBV,CAuBgB;AACzBC,aAxBS,CAwBe,EAxBf,CAyBTC,YAzBS,CAyBM,CAzBN,CA2BbN,aAAa,CAACO,eAAd,CAAgC,SAACC,CAAD,CAAkB,CAChD,GAAIA,CAAC,CAACC,IAAF,CAAOC,IAAP,CAAc,CAAlB,CAAqB,CACnBL,aAAa,CAACM,IAAd,CAAmBH,CAAC,CAACC,IAArB,EACA,MAAKjD,QAAL,CAAc,SAACoD,IAAD,QAAkB,CAC9BC,aAAa,8BAAMD,IAAI,CAACC,aAAX,GAA0BL,CAAC,CAACC,IAA5B,EADiB,CAAlB,EAAd,EAGD,CACF,CAPD,CASA;AACMK,kBArCO,CAqCcC,WAAW,sEAAC,mKACjCV,aAAa,CAACW,MAAd,CAAuB,CAAvB,EAA4B,MAAKvE,KAAL,CAAWW,WADN,0BAE7B6D,IAF6B,CAEtB,GAAIC,CAAAA,IAAJ,CAASb,aAAT,CAAwB,CAAEc,IAAI,CAAE,wBAAR,CAAxB,CAFsB,CAGnCd,aAAa,CAAG,EAAhB,CAAoB;AAHe,sBAKdY,CAAAA,IAAI,CAACG,WAAL,EALc,QAK7BC,MAL6B,eAM7BC,UAN6B,CAMhB,GAAIpE,CAAAA,UAAJ,CAAemE,MAAf,CANgB,CAOnCrF,SAAS,CAACuF,iBAAV,CAA4B,CAC1BC,GAAG,CAAEC,MAAM,CAACC,WAAP,CAAmBJ,UAAU,CAACK,OAAX,EAAnB,CADqB,CAE1BC,OAAO,CAAEtB,YAAY,EAFK,CAG1B/D,SAAS,CAAE,MAAKA,SAHU,CAI1BsF,OAAO,CAAE,KAJiB,CAA5B,EAPmC,sDAAD,GAcnCzB,cAdmC,CArCzB,CAqDbJ,aAAa,CAAC8B,MAAd,sEAAuB,+KACrBC,aAAa,CAACjB,kBAAD,CAAb,CAEA;AAHqB,KAIjBT,aAAa,CAACW,MAAd,CAAuB,CAJN,2BAKbC,IALa,CAKN,GAAIC,CAAAA,IAAJ,CAASb,aAAT,CAAwB,CAAEc,IAAI,CAAE,wBAAR,CAAxB,CALM,wBAMEF,CAAAA,IAAI,CAACG,WAAL,EANF,QAMbC,MANa,gBAObC,UAPa,CAOA,GAAIpE,CAAAA,UAAJ,CAAemE,MAAf,CAPA,CAQnBrF,SAAS,CAACuF,iBAAV,CAA4B,CAC1BC,GAAG,CAAEC,MAAM,CAACC,WAAP,CAAmBJ,UAAU,CAACK,OAAX,EAAnB,CADqB,CAE1BC,OAAO,CAAEtB,YAFiB,CAG1B/D,SAAS,CAAE,MAAKA,SAHU,CAI1BsF,OAAO,CAAE,IAJiB,CAA5B,EARmB,OAgBrB;AACMG,WAjBe,CAiBD,GAAId,CAAAA,IAAJ,CAAS,MAAKzE,KAAL,CAAWoE,aAApB,CAAmC,CAAEM,IAAI,CAAE,wBAAR,CAAnC,CAjBC,CAmBrB,MAAK3D,QAAL,CAAc,CACZyE,MAAM,CAAE,EADI,CAEZpB,aAAa,CAAE,EAFH,CAGZzD,WAAW,CAAE,KAHD,CAIZ4C,aAAa,CAAE,IAJH,CAKZkC,SAAS,CAAEF,WALC,CAMZG,QAAQ,CAAEC,GAAG,CAACC,eAAJ,CAAoBL,WAApB,CANE,CAAd,EAnBqB,yDAAvB,GA6BA;AACAhC,aAAa,CAACsC,KAAd,CAAoB,GAApB,EACA,MAAK9E,QAAL,CAAc,CACZwC,aAAa,CAAbA,aADY,CAEZ5C,WAAW,CAAE,IAFD,CAGZV,QAAQ,CAARA,QAHY,CAIZmE,aAAa,CAAE,EAJH,CAIQ;AACpBsB,QAAQ,CAAE,IALE,CAKQ;AACpBD,SAAS,CAAE,IAAS;AANR,CAAd,CAOG,MAAK1F,YAPR,EApFa,qFA8Fb+F,OAAO,CAACC,KAAR,CAAc,6BAAd,eA9Fa,uEA9GO,SAgNxBC,aAhNwB,CAgNR,UAAM,CACpB,GAAI,MAAKhG,KAAL,CAAWuD,aAAX,EAA4B,MAAKvD,KAAL,CAAWW,WAA3C,CAAwD,CACtD,MAAKX,KAAL,CAAWuD,aAAX,CAAyB0C,IAAzB,GACA,MAAKjG,KAAL,CAAWuD,aAAX,CAAyBP,MAAzB,CAAgCkD,SAAhC,GAA4CC,OAA5C,CAAoD,SAACC,KAAD,QAA6BA,CAAAA,KAAK,CAACH,IAAN,EAA7B,EAApD,EACA,GAAI,MAAKjG,KAAL,CAAWY,WAAf,CAA4B,CAC1BC,oBAAoB,CAAC,MAAKb,KAAL,CAAWY,WAAZ,CAApB,CACD,CACF,CACF,CAxNuB,OA0NxByF,cA1NwB,CA0NP,UAAY,CAC3B,GAAI,MAAKrG,KAAL,CAAWY,WAAf,CAA4B,CAC1BC,oBAAoB,CAAC,MAAKb,KAAL,CAAWY,WAAZ,CAApB,CACD,CAED,GAAI,MAAKZ,KAAL,CAAW0F,QAAf,CAAyB,CACvBC,GAAG,CAACW,eAAJ,CAAoB,MAAKtG,KAAL,CAAW0F,QAA/B,EACD,CAED,MAAK3E,QAAL,CAAc,CACZJ,WAAW,CAAE,KADD,CAEZ8E,SAAS,CAAE,IAFC,CAGZD,MAAM,CAAE,EAHI,CAIZpB,aAAa,CAAE,EAJH,CAKZsB,QAAQ,CAAE,IALE,CAMZa,SAAS,CAAE,IANC,CAOZtG,QAAQ,CAAE,IAPE,CAQZW,WAAW,CAAE,IARD,CAAd,EAUArB,SAAS,CAACuF,iBAAV,CAA4B,IAA5B,EACD,CA9OuB,OAgPxB0B,iBAhPwB,CAgPJ,UAAY,CAC9B,GAAI,MAAKxG,KAAL,CAAWyF,SAAf,CAA0B,CACxB,GAAMgB,CAAAA,QAAQ,CAAG,GAAIC,CAAAA,IAAJ,GAAWC,cAAX,GACdC,OADc,CACN,QADM,CACI,EADJ,EAEdA,OAFc,CAEN,IAFM,CAEA,EAFA,CAAjB,CAGA,GAAMC,CAAAA,QAAQ,2BAAsBJ,QAAtB,SAAd,CAEA,GAAMK,CAAAA,CAAC,CAAGC,QAAQ,CAACC,aAAT,CAAuB,GAAvB,CAAV,CACAF,CAAC,CAACG,KAAF,CAAQC,OAAR,CAAkB,MAAlB,CACAJ,CAAC,CAACK,IAAF,CAASxB,GAAG,CAACC,eAAJ,CAAoB,MAAK5F,KAAL,CAAWyF,SAA/B,CAAT,CACAqB,CAAC,CAACM,QAAF,CAAaP,QAAb,CACAE,QAAQ,CAACM,IAAT,CAAcC,WAAd,CAA0BR,CAA1B,EACAA,CAAC,CAACS,KAAF,GACAR,QAAQ,CAACM,IAAT,CAAcG,WAAd,CAA0BV,CAA1B,EACD,CACF,CA/PuB,OAiQjBW,MAjQiB,CAiQR,UAAiB,CAC/B,GAAMC,CAAAA,KAAK,CAAG,MAAK9H,KAAL,CAAW8H,KAAzB,CACA,GAAMT,CAAAA,KAA0B,CAAG,EAAnC,CAEA,GAAIS,KAAJ,CAAW,CACT,GAAMC,CAAAA,aAAa,qBACjB,MAAK3H,KAAL,CAAWW,WAAX,CAAyB,SAAzB,CAAqC,SADpB,CAAnB,CAGAsG,KAAK,CAACW,MAAN,CAAeD,aAAf,CACAV,KAAK,CAACY,OAAN,CAAgBF,aAAhB,CACD,CAED,mBACE,2BAAK,KAAK,CAAE,CAAEG,OAAO,CAAE,MAAX,CAAmBC,UAAU,CAAE,OAA/B,CAAwCC,YAAY,CAAE,MAAtD,CAA8DC,SAAS,CAAE,4BAAzE,CAAZ,eACE,8BACE,GAAG,CAAE,MAAKpI,SADZ,CAEE,KAAK,CAAC,KAFR,CAGE,MAAM,CAAC,KAHT,CAIE,KAAK,CAAE,CACLsB,KAAK,CAAE,MADF,CAEL+G,YAAY,CAAE,MAFT,CAGLF,YAAY,CAAE,KAHT,CAILG,eAAe,CAAE,MAAKnI,KAAL,CAAWW,WAAX,CAAyB,SAAzB,CAAqC,SAJjD,CAJT,EADF,cAaE,2BAAK,KAAK,CAAE,CAAEuG,OAAO,CAAE,MAAX,CAAmBkB,GAAG,CAAE,MAAxB,CAAgCC,cAAc,CAAE,QAAhD,CAAZ,EACG,CAAC,MAAKrI,KAAL,CAAWW,WAAZ,cACC,8BACE,OAAO,CAAE,MAAK2B,cADhB,CAEE,KAAK,CAAE,CACLwF,OAAO,CAAE,WADJ,CAELE,YAAY,CAAE,KAFT,CAGLJ,MAAM,CAAE,MAHH,CAILO,eAAe,CAAE,SAJZ,CAKLG,KAAK,CAAE,OALF,CAMLC,MAAM,CAAE,SANH,CAFT,oBADD,cAeC,8BACE,OAAO,CAAE,MAAKvC,aADhB,CAEE,KAAK,CAAE,CACL8B,OAAO,CAAE,WADJ,CAELE,YAAY,CAAE,KAFT,CAGLJ,MAAM,CAAE,MAHH,CAILO,eAAe,CAAE,SAJZ,CAKLG,KAAK,CAAE,OALF,CAMLC,MAAM,CAAE,SANH,CAFT,mBAhBJ,CA+BG,MAAKvI,KAAL,CAAW0F,QAAX,eACC,6BACE,GAAG,CAAE,MAAK1F,KAAL,CAAW0F,QADlB,CAEE,QAAQ,KAFV,CAGE,KAAK,CAAE,CAAE8C,SAAS,CAAE,MAAb,CAAqBrH,KAAK,CAAE,MAA5B,CAHT,EAhCJ,CAbF,CADF,CAuDD,CApUuB,CAEtB,MAAKnB,KAAL,CAAa,CACXW,WAAW,CAAE,KADF,CAEX4C,aAAa,CAAE,IAFJ,CAGXkC,SAAS,CAAE,IAHA,CAIXD,MAAM,CAAE,EAJG,CAKXE,QAAQ,CAAE,IALC,CAMXa,SAAS,CAAE,IANA,CAOXtG,QAAQ,CAAE,IAPC,CAQXW,WAAW,CAAE,IARF,CASXwD,aAAa,CAAE,EATJ,CAAb,CAWA,MAAKvE,SAAL,CAAiBH,KAAK,CAAC+I,SAAN,EAAjB,CACA,MAAK3I,SAAL,CAAiB,OAAS4G,IAAI,CAACgC,GAAL,EAAT,CAAsB,GAAtB,CAA4BC,IAAI,CAACC,MAAL,GAAcC,QAAd,CAAuB,EAAvB,EAA2BC,MAA3B,CAAkC,CAAlC,CAAqC,CAArC,CAA7C,CAdsB,aAevB,C,oEAED,4BAAoB,CAClB;AACA,GAAI,KAAKjJ,SAAL,CAAeK,OAAnB,CAA4B,CAC1B,GAAMC,CAAAA,MAAM,CAAG,KAAKN,SAAL,CAAeK,OAA9B,CACA,GAAME,CAAAA,SAAS,CAAGD,MAAM,CAACE,UAAP,CAAkB,IAAlB,CAAlB,CACA,GAAID,SAAJ,CAAe,CACbA,SAAS,CAACa,SAAV,CAAsB,SAAtB,CACAb,SAAS,CAACc,QAAV,CAAmB,CAAnB,CAAsB,CAAtB,CAAyBf,MAAM,CAACgB,KAAhC,CAAuChB,MAAM,CAACiB,MAA9C,EAEA;AACA,GAAMC,CAAAA,QAAQ,CAAGjB,SAAS,CAACkB,oBAAV,CAA+B,CAA/B,CAAkC,CAAlC,CAAqCnB,MAAM,CAACgB,KAA5C,CAAmD,CAAnD,CAAjB,CACAE,QAAQ,CAACE,YAAT,CAAsB,CAAtB,CAAyB,SAAzB,EACAF,QAAQ,CAACE,YAAT,CAAsB,CAAtB,CAAyB,SAAzB,EAEAnB,SAAS,CAACqB,WAAV,CAAwBJ,QAAxB,CACAjB,SAAS,CAACoB,SAAV,CAAsB,CAAtB,CACApB,SAAS,CAACsB,SAAV,GACAtB,SAAS,CAAC6B,MAAV,CAAiB,CAAjB,CAAoB9B,MAAM,CAACiB,MAAP,CAAgB,CAApC,EACAhB,SAAS,CAACgC,MAAV,CAAiBjC,MAAM,CAACgB,KAAxB,CAA+BhB,MAAM,CAACiB,MAAP,CAAgB,CAA/C,EACAhB,SAAS,CAACiC,MAAV,GACD,CACF,CACF,C,oCAED,+BAAuB,CACrB,GAAI,KAAKrC,KAAL,CAAWY,WAAf,CAA4B,CAC1BC,oBAAoB,CAAC,KAAKb,KAAL,CAAWY,WAAZ,CAApB,CACD,CACF,C,oCAjDkCpB,sB,EA2UrC,cAAeC,CAAAA,uBAAuB,CAACE,sBAAD,CAAtC,CAEAJ,SAAS,CAACwJ,iBAAV,GACAxJ,SAAS,CAACyJ,cAAV","sourcesContent":["import {\n  Streamlit,\n  StreamlitComponentBase,\n  withStreamlitConnection,\n} from \"streamlit-component-lib\"\nimport React, { ReactNode } from \"react\"\n\ninterface State {\n  isRecording: boolean\n  mediaRecorder: MediaRecorder | null\n  audioBlob: Blob | null\n  chunks: Blob[]\n  audioUrl: string | null\n  audioData: Float32Array | null\n  analyser: AnalyserNode | null\n  animationId: number | null\n  previewChunks: Blob[]\n}\n\nclass StreamlitAudioRecorder extends StreamlitComponentBase {\n  private canvasRef: React.RefObject<HTMLCanvasElement | null>\n  private sessionId: string;\n\n  constructor(props: any) {\n    super(props)\n    this.state = {\n      isRecording: false,\n      mediaRecorder: null,\n      audioBlob: null,\n      chunks: [],\n      audioUrl: null,\n      audioData: null,\n      analyser: null,\n      animationId: null,\n      previewChunks: []\n    }\n    this.canvasRef = React.createRef<HTMLCanvasElement | null>()\n    this.sessionId = 'rec_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n  }\n\n  componentDidMount() {\n    // Initialize canvas with a modern look\n    if (this.canvasRef.current) {\n      const canvas = this.canvasRef.current\n      const canvasCtx = canvas.getContext('2d')\n      if (canvasCtx) {\n        canvasCtx.fillStyle = '#f0f0f0'\n        canvasCtx.fillRect(0, 0, canvas.width, canvas.height)\n        \n        // Create gradient for the line\n        const gradient = canvasCtx.createLinearGradient(0, 0, canvas.width, 0)\n        gradient.addColorStop(0, '#ff4b4b')\n        gradient.addColorStop(1, '#ff8b8b')\n        \n        canvasCtx.strokeStyle = gradient\n        canvasCtx.lineWidth = 3\n        canvasCtx.beginPath()\n        canvasCtx.moveTo(0, canvas.height / 2)\n        canvasCtx.lineTo(canvas.width, canvas.height / 2)\n        canvasCtx.stroke()\n      }\n    }\n  }\n\n  componentWillUnmount() {\n    if (this.state.animationId) {\n      cancelAnimationFrame(this.state.animationId)\n    }\n  }\n\n  drawWaveform = () => {\n    if (this.state.analyser && this.canvasRef.current) {\n      const canvas = this.canvasRef.current\n      const canvasCtx = canvas.getContext('2d')\n      const bufferLength = this.state.analyser.frequencyBinCount\n      const dataArray = new Uint8Array(bufferLength)\n\n      const draw = () => {\n        if (!this.state.isRecording) {\n          if (this.state.animationId) {\n            cancelAnimationFrame(this.state.animationId)\n          }\n          return\n        }\n\n        const animationId = requestAnimationFrame(draw)\n        this.setState({ animationId })\n\n        this.state.analyser!.getByteTimeDomainData(dataArray)\n\n        if (canvasCtx) {\n          // Modern background\n          canvasCtx.fillStyle = '#f0f0f0'\n          canvasCtx.fillRect(0, 0, canvas.width, canvas.height)\n\n          // Create gradient for the waveform\n          const gradient = canvasCtx.createLinearGradient(0, 0, canvas.width, 0)\n          gradient.addColorStop(0, '#ff4b4b')\n          gradient.addColorStop(1, '#ff8b8b')\n          \n          canvasCtx.lineWidth = 3\n          canvasCtx.strokeStyle = gradient\n          canvasCtx.beginPath()\n\n          const sliceWidth = (canvas.width * 1.0) / bufferLength\n          let x = 0\n          let lastY = canvas.height / 2\n\n          for (let i = 0; i < bufferLength; i++) {\n            const v = dataArray[i] / 128.0\n            const y = (v * canvas.height) / 2\n\n            // Smooth the line using bezier curves\n            if (i === 0) {\n              canvasCtx.moveTo(x, y)\n            } else {\n              const xc = (x + (x - sliceWidth)) / 2\n              canvasCtx.quadraticCurveTo(x - sliceWidth, lastY, xc, y)\n            }\n\n            lastY = y\n            x += sliceWidth\n          }\n\n          canvasCtx.lineTo(canvas.width, canvas.height / 2)\n          canvasCtx.stroke()\n        }\n      }\n\n      draw()\n    }\n  }\n\n  startRecording = async () => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({\n        audio: {\n          channelCount: 1,\n          sampleRate: 44100,\n          echoCancellation: true,\n          noiseSuppression: true,\n          autoGainControl: true\n        }\n      })\n\n      const audioContext = new AudioContext()\n      const source = audioContext.createMediaStreamSource(stream)\n      const analyser = audioContext.createAnalyser()\n      source.connect(analyser)\n      \n      const mediaRecorder = new MediaRecorder(stream, {\n        mimeType: 'audio/webm;codecs=opus',\n        audioBitsPerSecond: 128000\n      })\n\n      // Send chunks every 5 seconds to stay well under Streamlit's size limits\n      const CHUNK_INTERVAL = 5000; // 5 seconds\n      let currentChunks: Blob[] = [];\n      let chunkCounter = 0;\n\n      mediaRecorder.ondataavailable = (e: BlobEvent) => {\n        if (e.data.size > 0) {\n          currentChunks.push(e.data);\n          this.setState((prev: State) => ({\n            previewChunks: [...prev.previewChunks, e.data]\n          }));\n        }\n      };\n\n      // Periodically send chunks\n      const sendChunksInterval = setInterval(async () => {\n        if (currentChunks.length > 0 && this.state.isRecording) {\n          const blob = new Blob(currentChunks, { type: 'audio/webm;codecs=opus' });\n          currentChunks = []; // Clear current chunks after creating blob\n          \n          const buffer = await blob.arrayBuffer();\n          const uint8Array = new Uint8Array(buffer);\n          Streamlit.setComponentValue({\n            arr: Object.fromEntries(uint8Array.entries()),\n            chunkId: chunkCounter++,\n            sessionId: this.sessionId,\n            isFinal: false\n          });\n        }\n      }, CHUNK_INTERVAL);\n\n      mediaRecorder.onstop = async () => {\n        clearInterval(sendChunksInterval);\n        \n        // Send any remaining chunks\n        if (currentChunks.length > 0) {\n          const blob = new Blob(currentChunks, { type: 'audio/webm;codecs=opus' });\n          const buffer = await blob.arrayBuffer();\n          const uint8Array = new Uint8Array(buffer);\n          Streamlit.setComponentValue({\n            arr: Object.fromEntries(uint8Array.entries()),\n            chunkId: chunkCounter,\n            sessionId: this.sessionId,\n            isFinal: true\n          });\n        }\n\n        // Create preview blob from all chunks\n        const previewBlob = new Blob(this.state.previewChunks, { type: 'audio/webm;codecs=opus' });\n        \n        this.setState({ \n          chunks: [], \n          previewChunks: [],\n          isRecording: false,\n          mediaRecorder: null,\n          audioBlob: previewBlob,\n          audioUrl: URL.createObjectURL(previewBlob)\n        });\n      };\n\n      // Start recording in smaller intervals for smooth waveform\n      mediaRecorder.start(100);\n      this.setState({ \n        mediaRecorder, \n        isRecording: true, \n        analyser,\n        previewChunks: [],  // Clear preview chunks when starting new recording\n        audioUrl: null,     // Clear previous audio URL\n        audioBlob: null     // Clear previous blob\n      }, this.drawWaveform);\n\n    } catch (err) {\n      console.error(\"Error accessing microphone:\", err)\n    }\n  }\n\n  stopRecording = () => {\n    if (this.state.mediaRecorder && this.state.isRecording) {\n      this.state.mediaRecorder.stop()\n      this.state.mediaRecorder.stream.getTracks().forEach((track: MediaStreamTrack) => track.stop())\n      if (this.state.animationId) {\n        cancelAnimationFrame(this.state.animationId)\n      }\n    }\n  }\n\n  resetRecording = (): void => {\n    if (this.state.animationId) {\n      cancelAnimationFrame(this.state.animationId)\n    }\n\n    if (this.state.audioUrl) {\n      URL.revokeObjectURL(this.state.audioUrl);\n    }\n\n    this.setState({\n      isRecording: false,\n      audioBlob: null,\n      chunks: [],\n      previewChunks: [],\n      audioUrl: null,\n      audioData: null,\n      analyser: null,\n      animationId: null\n    })\n    Streamlit.setComponentValue(null)\n  }\n\n  downloadRecording = (): void => {\n    if (this.state.audioBlob) {\n      const datetime = new Date().toLocaleString()\n        .replace(/[\\s,]/g, '')\n        .replace(/_/g, '')\n      const filename = `streamlit_audio_${datetime}.webm`\n\n      const a = document.createElement('a')\n      a.style.display = 'none'\n      a.href = URL.createObjectURL(this.state.audioBlob)\n      a.download = filename\n      document.body.appendChild(a)\n      a.click()\n      document.body.removeChild(a)\n    }\n  }\n\n  public render = (): ReactNode => {\n    const theme = this.props.theme\n    const style: React.CSSProperties = {}\n\n    if (theme) {\n      const borderStyling = `1px solid ${\n        this.state.isRecording ? '#ff4b4b' : \"#e0e0e0\"\n      }`\n      style.border = borderStyling\n      style.outline = borderStyling\n    }\n\n    return (\n      <div style={{ padding: '20px', background: 'white', borderRadius: '10px', boxShadow: '0 2px 10px rgba(0,0,0,0.1)' }}>\n        <canvas \n          ref={this.canvasRef} \n          width=\"500\" \n          height=\"100\" \n          style={{ \n            width: '100%', \n            marginBottom: '20px', \n            borderRadius: '5px',\n            backgroundColor: this.state.isRecording ? '#fff4f4' : '#f0f0f0'\n          }}\n        />\n        \n        <div style={{ display: 'flex', gap: '10px', justifyContent: 'center' }}>\n          {!this.state.isRecording ? (\n            <button\n              onClick={this.startRecording}\n              style={{\n                padding: '10px 20px',\n                borderRadius: '5px',\n                border: 'none',\n                backgroundColor: '#ff4b4b',\n                color: 'white',\n                cursor: 'pointer'\n              }}\n            >\n              Start Recording\n            </button>\n          ) : (\n            <button\n              onClick={this.stopRecording}\n              style={{\n                padding: '10px 20px',\n                borderRadius: '5px',\n                border: 'none',\n                backgroundColor: '#4b4bff',\n                color: 'white',\n                cursor: 'pointer'\n              }}\n            >\n              Stop Recording\n            </button>\n          )}\n          \n          {this.state.audioUrl && (\n            <audio \n              src={this.state.audioUrl} \n              controls \n              style={{ marginTop: '10px', width: '100%' }}\n            />\n          )}\n        </div>\n      </div>\n    )\n  }\n}\n\nexport default withStreamlitConnection(StreamlitAudioRecorder)\n\nStreamlit.setComponentReady()\nStreamlit.setFrameHeight()\n"]},"metadata":{},"sourceType":"module"}